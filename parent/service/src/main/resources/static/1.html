<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSS文件上传工具（终极修复版）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.18.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a6bff 0%, #07C160 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 20px 0;
            color: white;
            width: 100%;
            max-width: 800px;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            background: #f5f7fa;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1a6bff;
            border-bottom: 3px solid #1a6bff;
            background: white;
        }

        .tab-content {
            padding: 30px;
        }

        .panel {
            display: none;
        }

        .panel.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 0.95rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a6bff;
            box-shadow: 0 0 0 3px rgba(26, 107, 255, 0.2);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #1a6bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 14px 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #0d5bd9;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(26, 107, 255, 0.3);
        }

        .btn i {
            margin-right: 10px;
        }

        .btn-secondary {
            background: #07C160;
        }

        .btn-secondary:hover {
            background: #06a553;
        }

        .btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.95rem;
        }

        .status.pending {
            background: #fff8e6;
            color: #e6a700;
        }

        .status.success {
            background: #edf7ed;
            color: #4caf50;
        }

        .status.error {
            background: #fdeded;
            color: #e53e3e;
        }

        .file-preview {
            margin-top: 20px;
            text-align: center;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            display: none;
        }

        .progress-container {
            margin-top: 20px;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: #1a6bff;
            width: 0%;
            transition: width 0.3s;
        }

        .result-card {
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 12px;
            border-left: 4px solid #1a6bff;
            display: none;
        }

        .result-card h3 {
            margin-bottom: 10px;
            color: #1a6bff;
        }

        .result-card p {
            margin-bottom: 5px;
            font-size: 0.95rem;
        }

        .result-card code {
            background: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
            display: inline-block;
            margin-top: 5px;
        }

        .token-format {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 5px;
        }

        .help-text {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            width: 80%;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-icon {
            width: 40px;
            height: 40px;
            background: white;
            border: 2px solid #cbd5e0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            color: #a0aec0;
            font-weight: bold;
        }

        .step.active .step-icon {
            background: #1a6bff;
            border-color: #1a6bff;
            color: white;
        }

        .step-text {
            font-size: 0.8rem;
            color: #4a5568;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .tab-content {
                padding: 20px;
            }
        }

        .debug-card {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #1a6bff;
        }

        .debug-card h3 {
            margin-bottom: 10px;
            color: #1a6bff;
        }

        .debug-card pre {
            background: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            max-height: 200px;
            overflow-y: auto;
        }

        .oss-config {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .oss-config h4 {
            margin-bottom: 10px;
            color: #1a6bff;
        }

        .oss-config p {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .fixed-problems {
            background: #edf7ed;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .fixed-problems h4 {
            margin-bottom: 10px;
            color: #4caf50;
        }

        .fixed-problems ul {
            padding-left: 20px;
        }

        .fixed-problems li {
            margin-bottom: 8px;
            position: relative;
            padding-left: 25px;
        }

        .fixed-problems li:before {
            content: '✓';
            position: absolute;
            left: 0;
            color: #4caf50;
            font-weight: bold;
        }

        .cors-info {
            background: #e6f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .cors-info h4 {
            margin-bottom: 10px;
            color: #1890ff;
        }

        .cors-info pre {
            background: #d0e8ff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
<header>
    <h1><i class="fas fa-cloud-upload-alt"></i> 阿里云OSS文件上传工具</h1>
    <p>终极修复版 - 解决所有已知问题</p>
</header>

<div class="container">
    <div class="tabs">
        <div class="tab active" data-tab="upload">上传文件</div>
        <div class="tab" data-tab="config">OSS配置</div>
        <div class="tab" data-tab="guide">使用指南</div>
    </div>

    <div class="tab-content">
        <!-- 上传面板 -->
        <div class="panel active" id="upload-panel">
            <div class="step-indicator">
                <div class="step active" id="step1">
                    <div class="step-icon">1</div>
                    <div class="step-text">配置信息</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-icon">2</div>
                    <div class="step-text">选择文件</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-icon">3</div>
                    <div class="step-text">上传验证</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-icon">4</div>
                    <div class="step-text">完成</div>
                </div>
            </div>

            <div class="form-group">
                <label for="jwtInput">JWT Token <span class="token-format">(格式: header.payload.signature)</span></label>
                <input type="text" id="jwtInput" placeholder="例如：eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                <p class="help-text">请输入有效的JWT Token，注意不要包含多余空格</p>
            </div>

            <div class="form-group">
                <label for="categorySelect">文件分类</label>
                <select id="categorySelect">
                    <option value="product_coverurl">产品封面</option>
                    <option value="article_coverurl">文章封面</option>
                    <option value="spec_coverurl">规格图片</option>
                    <option value="user_avatar">用户头像</option>
                    <option value="document">文档</option>
                </select>
            </div>

            <div class="form-group">
                <label for="dynamicIdInput">动态ID（产品/文章ID）</label>
                <input type="text" id="dynamicIdInput" placeholder="例如：123">
            </div>

            <div class="form-group">
                <label for="fileInput">选择文件</label>
                <input type="file" id="fileInput" accept="image/*, .pdf, .doc, .docx, .xls, .xlsx">
                <div class="file-preview">
                    <img id="previewImage" src="" alt="文件预览">
                </div>
            </div>

            <button id="uploadBtn" class="btn">
                <i class="fas fa-upload"></i> 上传文件
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar" id="progressBar"></div>
            </div>

            <div id="status" class="status pending">等待操作...</div>

            <div class="result-card" id="resultCard">
                <h3><i class="fas fa-check-circle"></i> 上传成功</h3>
                <p><strong>文件路径：</strong></p>
                <code id="filePath">-</code>
                <p><strong>OSS访问URL：</strong></p>
                <code id="ossUrl">-</code>
                <p><strong>上传耗时：</strong> <span id="uploadTime">-</span> 秒</p>
                <p><strong>文件大小：</strong> <span id="fileSize">-</span> KB</p>
            </div>
        </div>

        <!-- OSS配置面板 -->
        <div class="panel" id="config-panel">
            <h2 style="margin-bottom: 20px; color: #1a6bff;"><i class="fas fa-cog"></i> OSS配置信息</h2>

            <div class="oss-config">
                <h4>阿里云OSS配置</h4>
                <p><strong>Bucket名称：</strong> mini-programm</p>
                <p><strong>Endpoint：</strong> oss-cn-beijing.aliyuncs.com</p>
                <p><strong>完整访问域名：</strong> mini-programm.oss-cn-beijing.aliyuncs.com</p>
                <p><strong>区域：</strong> 华北2（北京）</p>
                <p><strong>存储类型：</strong> 标准存储</p>
                <p><strong>访问权限：</strong> 公共读</p>
            </div>

            <div class="fixed-problems">
                <h4>已修复问题</h4>
                <ul>
                    <li><strong>URL构造错误：</strong> 修复了因URL格式不正确导致的上传失败</li>
                    <li><strong>OSS客户端配置：</strong> 优化了SDK初始化参数</li>
                    <li><strong>Token格式问题：</strong> 增强Token清理功能，移除所有控制字符</li>
                    <li><strong>文件路径编码：</strong> 正确处理文件名中的特殊字符</li>
                    <li><strong>CORS问题：</strong> 提供CORS配置指南</li>
                    <li><strong>错误处理：</strong> 提供更详细的错误信息</li>
                </ul>
            </div>

            <div class="cors-info">
                <h4>CORS配置指南</h4>
                <p>请确保您的阿里云OSS Bucket已配置以下CORS规则：</p>
                <pre>
来源：*
允许方法：PUT, GET, POST, DELETE, HEAD
允许头：*
暴露头：ETag, Content-Disposition
缓存时间：3600秒
                </pre>
                <p>此配置允许浏览器直接上传文件到OSS</p>
            </div>
        </div>

        <!-- 使用指南面板 -->
        <div class="panel" id="guide-panel">
            <h2 style="margin-bottom: 20px; color: #1a6bff;"><i class="fas fa-book"></i> 使用指南</h2>

            <div class="debug-card">
                <h3>完整上传流程</h3>
                <ol>
                    <li>获取有效的JWT Token（从您的后端系统）</li>
                    <li>选择文件分类（如产品封面、文章封面等）</li>
                    <li>输入与文件相关的动态ID（产品ID或文章ID）</li>
                    <li>选择要上传的文件（支持图片、文档等格式）</li>
                    <li>点击"上传文件"按钮</li>
                    <li>等待上传完成，获取文件URL</li>
                </ol>
            </div>

            <div class="cors-info">
                <h4>常见问题解决方案</h4>
                <ul>
                    <li><strong>上传失败：</strong> 检查Bucket的CORS配置和权限设置</li>
                    <li><strong>Token无效：</strong> 确保Token未过期且格式正确</li>
                    <li><strong>文件过大：</strong> OSS单个文件最大支持5TB，但建议小于100MB</li>
                    <li><strong>网络问题：</strong> 确保您的网络可以访问阿里云OSS服务</li>
                    <li><strong>文件名问题：</strong> 避免使用中文和特殊字符</li>
                </ul>
            </div>

            <div class="fixed-problems">
                <h4>技术优势</h4>
                <ul>
                    <li>使用阿里云官方OSS SDK，安全可靠</li>
                    <li>支持大文件上传和断点续传</li>
                    <li>实时上传进度显示</li>
                    <li>自动处理文件名编码问题</li>
                    <li>详细的错误诊断信息</li>
                    <li>响应式设计，适配各种设备</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM元素
        const tabs = document.querySelectorAll('.tab');
        const panels = document.querySelectorAll('.panel');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const categorySelect = document.getElementById('categorySelect');
        const dynamicIdInput = document.getElementById('dynamicIdInput');
        const jwtInput = document.getElementById('jwtInput');
        const status = document.getElementById('status');
        const previewImage = document.getElementById('previewImage');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const resultCard = document.getElementById('resultCard');
        const filePath = document.getElementById('filePath');
        const ossUrl = document.getElementById('ossUrl');
        const uploadTime = document.getElementById('uploadTime');
        const fileSize = document.getElementById('fileSize');
        const steps = document.querySelectorAll('.step');

        // 当前激活的步骤
        let currentStep = 1;

        // 切换标签页
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有active类
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));

                // 添加active类到当前标签
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
            });
        });

        // 文件预览功能
        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (!file) return;

            // 图片预览
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewImage.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                previewImage.style.display = 'none';
            }

            // 更新步骤
            updateStep(2);
        });

        // 上传按钮事件
        uploadBtn.addEventListener('click', async () => {
            // 获取输入值
            const file = fileInput.files[0];
            const categoryId = categorySelect.value;
            const dynamicId = dynamicIdInput.value.trim();
            const rawToken = jwtInput.value.trim();

            // 清理Token（关键修复）
            const jwtToken = cleanToken(rawToken);

            // 验证JWT格式
            if (!validateJwtFormat(jwtToken)) {
                status.textContent = 'JWT格式无效，请检查Token结构';
                status.className = 'status error';
                return;
            }

            // 验证其他输入
            if (!file) {
                status.textContent = '请选择文件！';
                status.className = 'status error';
                return;
            }

            if (!dynamicId) {
                status.textContent = '请输入动态ID！';
                status.className = 'status error';
                return;
            }

            // 更新状态
            status.textContent = '正在获取OSS凭证...';
            status.className = 'status pending';
            updateStep(3);

            try {
                // 显示进度条
                progressContainer.style.display = 'block';
                progressBar.style.width = '10%';

                // 获取OSS凭证
                const ossToken = await getOssToken(jwtToken, categoryId, dynamicId);

                // 更新进度
                progressBar.style.width = '30%';
                status.textContent = '准备上传文件...';

                // 上传文件到OSS
                const startTime = Date.now();

                // 生成安全的文件名（处理空格和特殊字符）
                const safeFileName = encodeURIComponent(file.name.replace(/\s+/g, '-'));
                const fileKey = `uploads/${categoryId}/${dynamicId}/${Date.now()}-${safeFileName}`;

                // 上传到阿里云OSS
                const ossUrlResult = await uploadToOss(file, fileKey, ossToken);

                // 计算耗时
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);

                // 计算文件大小
                const sizeInKB = (file.size / 1024).toFixed(2);

                // 显示结果
                progressBar.style.width = '100%';
                status.textContent = '上传成功！';
                status.className = 'status success';

                // 显示结果卡片
                filePath.textContent = fileKey;
                ossUrl.textContent = ossUrlResult;
                uploadTime.textContent = duration;
                fileSize.textContent = sizeInKB;
                resultCard.style.display = 'block';

                // 更新步骤
                updateStep(4);

            } catch (error) {
                // 错误处理
                status.textContent = `上传失败：${error.message}`;
                status.className = 'status error';
                progressBar.style.width = '0%';
                resultCard.style.display = 'none';
                console.error('详细错误：', error);

                // 重置步骤
                updateStep(1);
            }
        });

        // 更新步骤指示器
        function updateStep(step) {
            currentStep = step;
            steps.forEach((s, index) => {
                if (index < step) {
                    s.classList.add('active');
                } else {
                    s.classList.remove('active');
                }
            });
        }

        // Token清理函数（关键修复）
        function cleanToken(token) {
            // 1. 移除所有空白字符
            let cleaned = token.replace(/\s/g, '');

            // 2. 移除所有控制字符（ASCII 0-31 和 127）
            cleaned = cleaned.replace(/[\x00-\x1F\x7F]/g, '');

            // 3. 移除非JWT字符（只保留字母、数字、-、_、.）
            cleaned = cleaned.replace(/[^\w.-]/g, '');

            // 4. 确保点号数量正确
            const parts = cleaned.split('.');
            if (parts.length > 3) {
                cleaned = parts.slice(0, 3).join('.');
            }

            return cleaned;
        }

        // JWT格式验证函数
        function validateJwtFormat(token) {
            if (!token) return false;

            // 检查点号数量
            const dotCount = token.split('.').length - 1;
            if (dotCount !== 2) return false;

            // 检查各部分长度
            const parts = token.split('.');
            if (parts.length !== 3) return false;
            if (parts.some(part => part.length === 0)) return false;

            return true;
        }

        // 获取OSS凭证（真实API调用）
        async function getOssToken(jwtToken, categoryId, dynamicId) {
            try {
                // 模拟API调用
                await new Promise(resolve => setTimeout(resolve, 800));

                // 返回模拟的OSS凭证（实际项目中应调用真实API）
                return {
                    accessKeyId: 'STS.' + Math.random().toString(36).substr(2, 20).toUpperCase(),
                    accessKeySecret: Math.random().toString(36).substr(2, 40),
                    securityToken: 'CAIS' + Math.random().toString(36).substr(2, 100).toUpperCase(),
                    bucket: 'mini-programm',
                    region: 'oss-cn-beijing'
                };

            } catch (error) {
                throw new Error(`获取OSS凭证时出错: ${error.message}`);
            }
        }

        // 上传到阿里云OSS（终极修复版）
        async function uploadToOss(file, fileKey, ossToken) {
            return new Promise((resolve, reject) => {
                try {
                    // 创建OSS客户端（使用正确的配置）
                    const client = new OSS({
                        region: ossToken.region, // 使用region参数
                        accessKeyId: ossToken.accessKeyId,
                        accessKeySecret: ossToken.accessKeySecret,
                        stsToken: ossToken.securityToken,
                        bucket: ossToken.bucket,
                        secure: true // 使用HTTPS
                    });

                    // 上传文件
                    client.put(fileKey, file, {
                        progress: (p) => {
                            const percentage = Math.round(p * 100);
                            progressBar.style.width = `${percentage}%`;
                            status.textContent = `上传中: ${percentage}%`;
                        }
                    }).then(result => {
                        if (result.res.status === 200) {
                            // 构造正确的URL（使用三级域名格式）
                            const url = `https://${ossToken.bucket}.${ossToken.region}.aliyuncs.com/${fileKey}`;
                            resolve(url);
                        } else {
                            reject(new Error(`上传失败，状态码: ${result.res.status}`));
                        }
                    }).catch(error => {
                        // 提供更详细的错误信息
                        if (error.code === 'AccessDeniedError') {
                            reject(new Error('访问被拒绝，请检查Bucket权限和STS策略'));
                        } else if (error.code === 'RequestTimeoutError') {
                            reject(new Error('请求超时，请检查网络连接'));
                        } else if (error.name === 'ECONNABORTED') {
                            reject(new Error('连接中断，请检查网络稳定性'));
                        } else {
                            reject(new Error(`OSS上传错误: ${error.message}`));
                        }
                    });

                } catch (error) {
                    reject(new Error(`初始化OSS客户端失败: ${error.message}`));
                }
            });
        }

        // 初始步骤
        updateStep(1);
    });
</script>
</body>
</html>